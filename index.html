<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>JSQ → Affinity CSV Sync</title>
    <style>
      :root {
        --bg: #0b0c10;
        --card: #14161c;
        --muted: #a6adbb;
        --text: #e8eef7;
        --accent: #6ea8fe;
        --accent-2: #8b5cf6;
        --border: #20232b;
        --success: #22c55e;
        --warn: #f59e0b;
        --danger: #ef4444;
        --shadow: 0 10px 30px rgba(0,0,0,0.35);
      }
      html, body { height: 100%; }
      body {
        margin: 0;
        font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        color: var(--text);
        background: radial-gradient(1200px 600px at 10% -10%, rgba(110,168,254,0.12), transparent 60%), radial-gradient(800px 400px at 100% 0%, rgba(139,92,246,0.12), transparent 60%), var(--bg);
      }
      .container {
        max-width: 960px;
        margin: 0 auto;
        padding: 24px;
      }
      .hero {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 24px;
      }
      .hero-title {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      h1 {
        font-size: 28px;
        line-height: 1.2;
        margin: 0;
        letter-spacing: -0.01em;
      }
      .subtitle {
        color: var(--muted);
        font-size: 14px;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: linear-gradient(90deg, rgba(110,168,254,0.25), rgba(139,92,246,0.25));
        border: 1px solid var(--border);
        padding: 8px 12px;
        border-radius: 999px;
        font-size: 12px;
        color: var(--text);
      }
      .card {
        background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent), var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        box-shadow: var(--shadow);
        padding: 20px;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
      @media (max-width: 820px) {
        .grid { grid-template-columns: 1fr; }
      }
      .section {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      label { font-size: 13px; color: var(--muted); }
      .input, .password {
        width: 100%;
        border: 1px solid var(--border);
        background: #0f1117;
        color: var(--text);
        padding: 10px 12px;
        border-radius: 10px;
        outline: none;
        transition: border-color 0.2s ease;
      }
      .input:focus, .password:focus { border-color: var(--accent); }

      .toggle {
        display: inline-flex; align-items: center; gap: 10px;
        user-select: none;
      }
      .switch {
        position: relative; width: 46px; height: 26px; border-radius: 999px;
        background: #232734; border: 1px solid var(--border);
        cursor: pointer; transition: background 0.2s ease;
      }
      .switch.checked { background: #244467; border-color: #2e5380; }
      .knob {
        position: absolute; top: 2px; left: 2px; width: 22px; height: 22px;
        background: #fff; border-radius: 50%; transition: left 0.2s ease;
      }
      .switch.checked .knob { left: 22px; }

      .dropzone {
        border: 1.5px dashed #2a2f3b;
        background: #0f1117;
        border-radius: 12px; padding: 18px; text-align: center; color: var(--muted);
        transition: border-color 0.2s ease, background 0.2s ease;
      }
      .dropzone.dragover { border-color: var(--accent); background: #0f1420; }
      .actions { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
      .btn {
        display: inline-flex; align-items: center; gap: 8px;
        padding: 10px 14px; border-radius: 10px; cursor: pointer; 
        border: 1px solid var(--border); background: linear-gradient(180deg, #1a1e28, #151823);
        color: var(--text);
      }
      .btn-primary {
        border-color: transparent;
        background: linear-gradient(90deg, var(--accent), var(--accent-2));
        color: #0b0c10;
        font-weight: 600;
      }
      .btn:disabled { opacity: 0.6; cursor: not-allowed; }

      .results {
        margin-top: 20px;
        background: #0f1117; border: 1px solid var(--border); border-radius: 12px; padding: 14px;
      }
      .meta { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
      .chip { padding: 4px 10px; border-radius: 999px; font-size: 12px; border: 1px solid var(--border); }
      .chip-ok { background: rgba(34,197,94,0.12); color: #22c55e; border-color: rgba(34,197,94,0.35); }
      .chip-err { background: rgba(239,68,68,0.12); color: #ef4444; border-color: rgba(239,68,68,0.35); }
      .muted { color: var(--muted); }
      pre { margin: 0; white-space: pre-wrap; word-break: break-word; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="hero">
        <div class="hero-title">
          <h1>Juniper Square → Affinity CSV Sync</h1>
          <div class="subtitle">Securely upload a JSQ export. We match by name (exact → fuzzy), enforce a minimum stage, and update Affinity statuses.</div>
        </div>
        <div class="badge" title="Requests require an API key and are never cached">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L20 6V18L12 22L4 18V6L12 2Z" stroke="currentColor" stroke-width="1.5"/><path d="M12 8V12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><circle cx="12" cy="16" r="1" fill="currentColor"/></svg>
          Protected endpoint
        </div>
      </div>

      <div class="card">
        <div class="grid">
          <div class="section">
            <label>API Key (required)</label>
            <div class="actions">
              <input id="apiKey" type="password" class="password" placeholder="CSV_SYNC_API_KEY" autocomplete="off" />
              <button id="toggleKey" class="btn" title="Show / hide key">Show</button>
            </div>
            <label>Options</label>
            <div class="toggle">
              <div id="drySwitch" class="switch"><div class="knob"></div></div>
              <div class="muted">Preview only (dry‑run)</div>
            </div>
            <div class="muted">Minimum status threshold is enforced on the server (default: Data Room Accessed / NDA Executed).</div>
          </div>

          <div class="section">
            <label>CSV file</label>
            <div id="dropzone" class="dropzone">
              <div style="margin-bottom:6px; font-weight:600; color: #cbd5e1;">Drop CSV here or click to choose</div>
              <div class="muted" style="font-size: 12px;">We accept standard CSV exports from Juniper Square</div>
              <input id="file" type="file" accept=".csv,text/csv" style="display:none" />
            </div>
            <div class="actions">
              <button id="send" class="btn btn-primary">Upload & Sync</button>
              <button id="clear" class="btn" title="Clear the output">Clear</button>
            </div>
          </div>
        </div>

        <div class="results">
          <div class="meta">
            <div id="statusChip" class="chip">Idle</div>
            <div id="summary" class="muted">Waiting for upload…</div>
          </div>
          <pre id="out"></pre>
        </div>
      </div>
    </div>

    <script>
      const fileEl = document.getElementById('file');
      const dropzone = document.getElementById('dropzone');
      const sendBtn = document.getElementById('send');
      const clearBtn = document.getElementById('clear');
      const out = document.getElementById('out');
      const apiKeyEl = document.getElementById('apiKey');
      const toggleKeyBtn = document.getElementById('toggleKey');
      const drySwitch = document.getElementById('drySwitch');
      const statusChip = document.getElementById('statusChip');
      const summary = document.getElementById('summary');

      let currentFile = null;

      function setChip(state, text) {
        statusChip.className = 'chip ' + (state === 'ok' ? 'chip-ok' : state === 'err' ? 'chip-err' : '');
        statusChip.textContent = text;
      }
      function setSummary(text) { summary.textContent = text; }

      // Persist API key + dry switch
      (function initPersist() {
        try {
          const k = localStorage.getItem('csv_sync_api_key');
          if (k) apiKeyEl.value = k;
          const d = localStorage.getItem('csv_sync_dry');
          if (d === '1') { drySwitch.classList.add('checked'); }
        } catch {}
      })();

      toggleKeyBtn.addEventListener('click', () => {
        apiKeyEl.type = apiKeyEl.type === 'password' ? 'text' : 'password';
        toggleKeyBtn.textContent = apiKeyEl.type === 'password' ? 'Show' : 'Hide';
      });
      drySwitch.addEventListener('click', () => {
        drySwitch.classList.toggle('checked');
        try { localStorage.setItem('csv_sync_dry', drySwitch.classList.contains('checked') ? '1' : '0'); } catch {}
      });

      // Dropzone interactions
      dropzone.addEventListener('click', () => fileEl.click());
      dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('dragover'); });
      dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
      dropzone.addEventListener('drop', (e) => {
        e.preventDefault(); dropzone.classList.remove('dragover');
        const f = e.dataTransfer.files[0];
        if (f) { currentFile = f; dropzone.querySelector('.muted').textContent = f.name; }
      });
      fileEl.addEventListener('change', () => {
        const f = fileEl.files[0];
        if (f) { currentFile = f; dropzone.querySelector('.muted').textContent = f.name; }
      });

      clearBtn.addEventListener('click', () => { out.textContent = ''; setChip('', 'Idle'); setSummary('Waiting for upload…'); });

      async function uploadCsv() {
        const f = currentFile || fileEl.files[0];
        if (!f) { setChip('err', 'Error'); setSummary('Please choose a CSV file.'); return; }
        const apiKey = apiKeyEl.value.trim();
        if (!apiKey) { setChip('err', 'Error'); setSummary('Please enter the API key.'); return; }
        try { localStorage.setItem('csv_sync_api_key', apiKey); } catch {}
        const dry = drySwitch.classList.contains('checked');

        sendBtn.disabled = true;
        setChip('', 'Working…');
        setSummary('Uploading and processing…');
        out.textContent = '';
        try {
          const text = await f.text();
          const url = dry ? '/api/upload?dry=1' : '/api/upload';
          const resp = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'text/csv', 'x-api-key': apiKey },
            body: text
          });
          const data = await resp.json();
          if (data && data.ok) { setChip('ok', 'Success'); setSummary(`Processed ${data.total} rows`); }
          else { setChip('err', 'Failed'); setSummary(data?.error || 'Request failed'); }
          out.textContent = JSON.stringify(data, null, 2);
        } catch (e) {
          setChip('err', 'Error');
          setSummary(e?.message || String(e));
        } finally {
          sendBtn.disabled = false;
        }
      }

      sendBtn.addEventListener('click', uploadCsv);
    </script>
  </body>
  </html>


